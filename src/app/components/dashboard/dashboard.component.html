<div class="wrapper">
    <app-sidebar></app-sidebar>

    <div class="main">
        <main class="content">
            <!-- Header -->
            <div class="header mb-4">
                <h1 class="header-title">
                    <i class="fas fa-chart-line"></i>
                    Dashboard
                </h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="#">Inicio</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Dashboard</li>
                    </ol>
                </nav>
            </div>

            <!-- Cards de Estadísticas Principales -->
            <div class="row mb-4">
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="stat-card stat-card-primary">
                        <div class="stat-card-body">
                            <div class="stat-icon">
                                <i class="fas fa-box"></i>
                            </div>
                            <div class="stat-info">
                                <h5 class="stat-title">Productos</h5>
                                <p class="stat-value">{{ data.num_productos | number }}</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="stat-card stat-card-info">
                        <div class="stat-card-body">
                            <div class="stat-icon">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <div class="stat-info">
                                <h5 class="stat-title">Inversión</h5>
                                <p class="stat-value">
                                    <span class="currency-amount">{{ data.plata_invertida | number:'1.0-0' }}</span>
                                    <span class="currency-code">COP</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="stat-card stat-card-success">
                        <div class="stat-card-body">
                            <div class="stat-icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="stat-info">
                                <h5 class="stat-title">Valor Inventario</h5>
                                <p class="stat-value">
                                    <span class="currency-amount">{{ data.plata_vender | number:'1.0-0' }}</span>
                                    <span class="currency-code">COP</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="stat-card stat-card-warning">
                        <div class="stat-card-body">
                            <div class="stat-icon">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                            <div class="stat-info">
                                <h5 class="stat-title">Total Ventas</h5>
                                <p class="stat-value">{{ data.num_ventas | number }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sección de Saldos -->
            <div class="row mb-4">
                <div class="col-lg-8 mb-3">
                    <div class="card card-saldos">
                        <div class="card-header">
                            <div>
                                <h5 class="card-title">
                                    <i class="fas fa-wallet"></i>
                                    Monitoreo de Saldos
                                </h5>
                                <small class="text-muted">
                                    <i class="fas fa-info-circle"></i>
                                    Sistema de seguimiento de movimientos de dinero
                                </small>
                            </div>
                            <button class="btn btn-sm btn-primary" (click)="openUpdateModal()">
                                <i class="fas fa-edit"></i>
                                Registrar Movimiento
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <!-- Efectivo -->
                                <div class="col-md-4 mb-3">
                                    <div class="saldo-card saldo-efectivo">
                                        <div class="saldo-card-header">
                                            <i class="fas fa-money-bill-wave"></i>
                                            <h6>Efectivo</h6>
                                        </div>
                                        <div class="saldo-card-body">
                                            <p class="saldo-value">
                                                <span class="currency-amount">{{ saldos.efectivo | number:'1.0-0' }}</span>
                                                <span class="currency-code">COP</span>
                                            </p>
                                            <div class="saldo-comparison" *ngIf="originalSaldos.efectivo !== saldos.efectivo">
                                                <small class="saldo-original">
                                                    <i class="fas fa-history"></i>
                                                    Anterior: <span class="currency-amount-small">{{ originalSaldos.efectivo | number:'1.0-0' }}</span> COP
                                                </small>
                                                <span class="saldo-badge" 
                                                      [class.badge-up]="saldos.efectivo > originalSaldos.efectivo"
                                                      [class.badge-down]="saldos.efectivo < originalSaldos.efectivo">
                                                    <i class="fas" 
                                                       [class.fa-arrow-up]="saldos.efectivo > originalSaldos.efectivo"
                                                       [class.fa-arrow-down]="saldos.efectivo < originalSaldos.efectivo"></i>
                                                    {{ (saldos.efectivo - originalSaldos.efectivo) | number:'1.0-0' }} COP
                                                </span>
                                            </div>
                                            <small class="saldo-no-change" *ngIf="originalSaldos.efectivo === saldos.efectivo">
                                                <i class="fas fa-check-circle"></i>
                                                Sin cambios
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Nequi -->
                                <div class="col-md-4 mb-3">
                                    <div class="saldo-card saldo-nequi">
                                        <div class="saldo-card-header">
                                            <i class="fas fa-mobile-alt"></i>
                                            <h6>Nequi</h6>
                                        </div>
                                        <div class="saldo-card-body">
                                            <p class="saldo-value">
                                                <span class="currency-amount">{{ saldos.nequi | number:'1.0-0' }}</span>
                                                <span class="currency-code">COP</span>
                                            </p>
                                            <div class="saldo-comparison" *ngIf="originalSaldos.nequi !== saldos.nequi">
                                                <small class="saldo-original">
                                                    <i class="fas fa-history"></i>
                                                    Anterior: <span class="currency-amount-small">{{ originalSaldos.nequi | number:'1.0-0' }}</span> COP
                                                </small>
                                                <span class="saldo-badge" 
                                                      [class.badge-up]="saldos.nequi > originalSaldos.nequi"
                                                      [class.badge-down]="saldos.nequi < originalSaldos.nequi">
                                                    <i class="fas" 
                                                       [class.fa-arrow-up]="saldos.nequi > originalSaldos.nequi"
                                                       [class.fa-arrow-down]="saldos.nequi < originalSaldos.nequi"></i>
                                                    {{ (saldos.nequi - originalSaldos.nequi) | number:'1.0-0' }} COP
                                                </span>
                                            </div>
                                            <small class="saldo-no-change" *ngIf="originalSaldos.nequi === saldos.nequi">
                                                <i class="fas fa-check-circle"></i>
                                                Sin cambios
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Sin Pagar -->
                                <div class="col-md-4 mb-3">
                                    <div class="saldo-card saldo-pendiente">
                                        <div class="saldo-card-header">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            <h6>Sin Pagar</h6>
                                        </div>
                                        <div class="saldo-card-body">
                                            <p class="saldo-value">
                                                <span class="currency-amount">{{ saldos.sin_pagar | number:'1.0-0' }}</span>
                                                <span class="currency-code">COP</span>
                                            </p>
                                            <div class="saldo-comparison" *ngIf="originalSaldos.sin_pagar !== saldos.sin_pagar">
                                                <small class="saldo-original">
                                                    <i class="fas fa-history"></i>
                                                    Anterior: <span class="currency-amount-small">{{ originalSaldos.sin_pagar | number:'1.0-0' }}</span> COP
                                                </small>
                                                <span class="saldo-badge" 
                                                      [class.badge-up]="saldos.sin_pagar > originalSaldos.sin_pagar"
                                                      [class.badge-down]="saldos.sin_pagar < originalSaldos.sin_pagar">
                                                    <i class="fas" 
                                                       [class.fa-arrow-up]="saldos.sin_pagar > originalSaldos.sin_pagar"
                                                       [class.fa-arrow-down]="saldos.sin_pagar < originalSaldos.sin_pagar"></i>
                                                    {{ (saldos.sin_pagar - originalSaldos.sin_pagar) | number:'1.0-0' }} COP
                                                </span>
                                            </div>
                                            <small class="saldo-no-change" *ngIf="originalSaldos.sin_pagar === saldos.sin_pagar">
                                                <i class="fas fa-check-circle"></i>
                                                Sin cambios
                                            </small>
                                            <div class="saldo-info" *ngIf="saldos.info_sin_pagar">
                                                <small><i class="fas fa-info-circle"></i> {{ saldos.info_sin_pagar }}</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Total -->
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="saldo-total-card">
                                        <div class="saldo-total-content">
                                            <div class="saldo-total-info">
                                                <div class="saldo-total-label">
                                                    <i class="fas fa-coins"></i>
                                                    <span>Total Disponible</span>
                                                </div>
                                                <p class="saldo-total-value">
                                                    <span class="currency-amount">{{ getTotalSaldo() | number:'1.0-0' }}</span>
                                                    <span class="currency-code">COP</span>
                                                </p>
                                            </div>
                                            <div class="saldo-total-stats" *ngIf="getTotalSaldo() > 0">
                                                <div class="total-stat-item">
                                                    <small>Efectivo</small>
                                                    <strong>{{ ((saldos.efectivo / getTotalSaldo()) * 100) | number:'1.0-0' }}%</strong>
                                                </div>
                                                <div class="total-stat-item">
                                                    <small>Nequi</small>
                                                    <strong>{{ ((saldos.nequi / getTotalSaldo()) * 100) | number:'1.0-0' }}%</strong>
                                                </div>
                                                <div class="total-stat-item">
                                                    <small>Pendiente</small>
                                                    <strong>{{ ((saldos.sin_pagar / getTotalSaldo()) * 100) | number:'1.0-0' }}%</strong>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gráfica de Distribución de Saldos -->
                <div class="col-lg-4 mb-3">
                    <div class="card card-saldos">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="fas fa-chart-pie"></i>
                                Distribución
                            </h5>
                        </div>
                        <div class="card-body">
                            <canvas baseChart 
                                    [chartType]="'doughnut'" 
                                    [datasets]="saldoChartData"
                                    [labels]="saldoChartLabels"
                                    [options]="saldoChartOptions"
                                    [colors]="saldoChartColors"
                                    *ngIf="getTotalSaldo() > 0">
                            </canvas>
                            <div class="empty-chart" *ngIf="getTotalSaldo() === 0">
                                <i class="fas fa-chart-pie"></i>
                                <p>No hay saldos</p>
                            </div>
                            <div class="chart-legend mt-2" *ngIf="getTotalSaldo() > 0">
                                <div class="legend-item">
                                    <span class="legend-dot" style="background: #10b981;"></span>
                                    <span>Efectivo: {{ ((saldos.efectivo / getTotalSaldo()) * 100) | number:'1.0-0' }}%</span>
                                </div>
                                <div class="legend-item">
                                    <span class="legend-dot" style="background: #3b82f6;"></span>
                                    <span>Nequi: {{ ((saldos.nequi / getTotalSaldo()) * 100) | number:'1.0-0' }}%</span>
                                </div>
                                <div class="legend-item">
                                    <span class="legend-dot" style="background: #ef4444;"></span>
                                    <span>Sin Pagar: {{ ((saldos.sin_pagar / getTotalSaldo()) * 100) | number:'1.0-0' }}%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Historial de Movimientos -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="fas fa-history"></i>
                                Historial de Movimientos
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="loading-historial" *ngIf="isLoadingHistorial">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Cargando historial...</p>
                            </div>
                            <div class="historial-container" *ngIf="!isLoadingHistorial && historialSaldos && historialSaldos.length > 0">
                                <div class="historial-item" *ngFor="let movimiento of historialSaldos; let i = index">
                                    <div class="historial-header">
                                        <div class="historial-number">#{{ historialSaldos.length - i }}</div>
                                        <div class="historial-date">
                                            <i class="fas fa-clock"></i>
                                            <span class="relative-time">{{ getRelativeTime(movimiento.fecha) }}</span>
                                            <small class="absolute-time">({{ movimiento.fecha | date:'dd/MM/yyyy HH:mm' }})</small>
                                        </div>
                                    </div>
                                    <div class="historial-content">
                                        <div class="historial-saldos">
                                            <div class="historial-saldo-item">
                                                <i class="fas fa-money-bill-wave text-success"></i>
                                                <span>Efectivo: <strong>{{ movimiento.efectivo | number:'1.0-0' }} COP</strong></span>
                                            </div>
                                            <div class="historial-saldo-item">
                                                <i class="fas fa-mobile-alt text-primary"></i>
                                                <span>Nequi: <strong>{{ movimiento.nequi | number:'1.0-0' }} COP</strong></span>
                                            </div>
                                            <div class="historial-saldo-item">
                                                <i class="fas fa-exclamation-triangle text-danger"></i>
                                                <span>Sin Pagar: <strong>{{ movimiento.sin_pagar | number:'1.0-0' }} COP</strong></span>
                                            </div>
                                        </div>
                                        <div class="historial-motivo" *ngIf="movimiento.motivo">
                                            <i class="fas fa-comment-alt"></i>
                                            <span>{{ movimiento.motivo }}</span>
                                        </div>
                                        <div class="historial-info" *ngIf="movimiento.info_sin_pagar">
                                            <i class="fas fa-info-circle"></i>
                                            <span>{{ movimiento.info_sin_pagar }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="empty-historial" *ngIf="!isLoadingHistorial && (!historialSaldos || historialSaldos.length === 0)">
                                <i class="fas fa-history"></i>
                                <p>No hay movimientos registrados</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Análisis de Inventario -->
            <div class="row mb-4">
                <div class="col-lg-6 mb-3">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="fas fa-chart-bar"></i>
                                Análisis de Inventario
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container-large">
                                <canvas baseChart 
                                        [chartType]="'bar'" 
                                        [datasets]="inventarioChartData"
                                        [labels]="inventarioChartLabels"
                                        [options]="inventarioChartOptions"
                                        [colors]="inventarioChartColors">
                                </canvas>
                            </div>
                            <div class="chart-info mt-3">
                                <div class="info-item">
                                    <span class="info-label">Inversión:</span>
                                    <span class="info-value">{{ data.plata_invertida | number:'1.0-0' }} COP</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Valor Venta:</span>
                                    <span class="info-value">{{ data.plata_vender | number:'1.0-0' }} COP</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Margen:</span>
                                    <span class="info-value text-warning">{{ (data.plata_vender - data.plata_invertida) | number:'1.0-0' }} COP</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 mb-3">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="fas fa-tags"></i>
                                Productos por Categoría
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="categorias-list-container" *ngIf="productosPorCategoria.length > 0">
                                <div class="categorias-list">
                                    <div class="categoria-item" 
                                         *ngFor="let categoria of productosPorCategoria"
                                         (click)="verProductosCategoria(categoria)">
                                        <div class="categoria-info">
                                            <div class="categoria-name">
                                                <i class="fas fa-folder"></i>
                                                <span>{{ categoria.nombre }}</span>
                                            </div>
                                            <div class="categoria-stats">
                                                <span class="categoria-count">{{ categoria.cantidad }} productos</span>
                                                <span class="categoria-percent">{{ categoria.porcentaje }}%</span>
                                            </div>
                                        </div>
                                        <div class="categoria-bar">
                                            <div class="categoria-bar-fill" [style.width.%]="categoria.porcentaje"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="empty-list" *ngIf="productosPorCategoria.length === 0">
                                <i class="fas fa-tags"></i>
                                <p>No hay productos</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Productos con Stock Bajo -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="fas fa-exclamation-triangle text-warning"></i>
                                Productos con Stock Bajo
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="stock-bajo-table" *ngIf="productosStockBajo.length > 0">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th style="width: 60px;">Imagen</th>
                                            <th>Producto</th>
                                            <th>Identificador</th>
                                            <th>Stock Actual</th>
                                            <th>Precio Compra</th>
                                            <th>Precio Venta</th>
                                            <th>Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr *ngFor="let producto of productosStockBajo">
                                            <td>
                                                <div class="producto-image-cell" [attr.data-producto-id]="producto._id">
                                                    <img *ngIf="getProductImage(producto)" 
                                                         [src]="getProductImage(producto)" 
                                                         [alt]="producto.titulo"
                                                         class="producto-thumbnail"
                                                         (click)="verImagenProducto(producto)"
                                                         (error)="$event.target.src='assets/img/no-image.png'">
                                                    <div *ngIf="!getProductImage(producto) && !isImageLoading(producto)" 
                                                         class="producto-no-image"
                                                         (click)="verImagenProducto(producto)">
                                                        <i class="fas fa-image"></i>
                                                    </div>
                                                    <div *ngIf="isImageLoading(producto)" 
                                                         class="producto-loading-image">
                                                        <i class="fas fa-spinner fa-spin"></i>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="producto-name-cell">
                                                    <i class="fas fa-box"></i>
                                                    <span>{{ producto.titulo }}</span>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge badge-secondary">{{ producto.identificador }}</span>
                                            </td>
                                            <td>
                                                <span class="stock-badge" 
                                                      [class.stock-critico]="producto.stock <= 3"
                                                      [class.stock-bajo]="producto.stock > 3 && producto.stock <= 5"
                                                      [class.stock-medio]="producto.stock > 5">
                                                    {{ producto.stock }} unidades
                                                </span>
                                            </td>
                                            <td>
                                                <span class="price-value price-compra">{{ producto.precio_compra | number:'1.0-0' }} COP</span>
                                            </td>
                                            <td>
                                                <span class="price-value">{{ producto.precio_venta | number:'1.0-0' }} COP</span>
                                            </td>
                                            <td>
                                                <span class="status-badge" 
                                                      [class.status-critico]="producto.stock <= 3"
                                                      [class.status-alerta]="producto.stock > 3 && producto.stock <= 5"
                                                      [class.status-ok]="producto.stock > 5">
                                                    <i class="fas" 
                                                       [class.fa-exclamation-circle]="producto.stock <= 5"
                                                       [class.fa-exclamation-triangle]="producto.stock > 5 && producto.stock <= 7"
                                                       [class.fa-info-circle]="producto.stock > 7"></i>
                                                    {{ producto.stock <= 3 ? 'Crítico' : (producto.stock <= 5 ? 'Bajo' : 'Atención') }}
                                                </span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="empty-list" *ngIf="productosStockBajo.length === 0">
                                <i class="fas fa-check-circle text-success"></i>
                                <p>Todo el stock está en buen estado</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Modal para Productos por Categoría -->
<div class="modal fade" id="modalProductosCategoria" tabindex="-1" role="dialog" aria-labelledby="modalProductosCategoriaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h5 class="modal-title" id="modalProductosCategoriaLabel">
                        <i class="fas fa-folder"></i>
                        Productos: {{ categoriaSeleccionada?.nombre }}
                    </h5>
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i>
                        {{ categoriaSeleccionada?.cantidad }} productos en esta categoría
                    </small>
                </div>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" (click)="cerrarModalCategoria()">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="productos-categoria-grid" *ngIf="productosCategoriaSeleccionada.length > 0">
                    <div class="producto-categoria-card" *ngFor="let producto of productosCategoriaSeleccionada">
                        <div class="producto-categoria-image" 
                             (click)="verImagenProducto(producto)"
                             [attr.data-producto-id]="producto._id">
                            <img *ngIf="getProductImage(producto)" 
                                 [src]="getProductImage(producto)" 
                                 [alt]="producto.titulo"
                                 class="producto-image"
                                 (error)="$event.target.src='assets/img/no-image.png'">
                            <div *ngIf="!getProductImage(producto) && !isImageLoading(producto)" class="producto-no-image-large">
                                <i class="fas fa-image"></i>
                            </div>
                            <div *ngIf="isImageLoading(producto)" class="producto-loading-image-large">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Cargando...</p>
                            </div>
                        </div>
                        <div class="producto-categoria-header">
                            <div class="producto-categoria-title">
                                <i class="fas fa-box"></i>
                                <span>{{ producto.titulo }}</span>
                            </div>
                            <span class="producto-categoria-badge" 
                                  [class.stock-critico]="producto.stock <= 3"
                                  [class.stock-bajo]="producto.stock > 3 && producto.stock <= 5"
                                  [class.stock-ok]="producto.stock > 5">
                                {{ producto.stock }} unidades
                            </span>
                        </div>
                        <div class="producto-categoria-body">
                            <div class="producto-categoria-info">
                                <div class="info-row">
                                    <span class="info-label">ID:</span>
                                    <span class="info-value">{{ producto.identificador || 'N/A' }}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Stock:</span>
                                    <span class="info-value">{{ producto.stock }} unidades</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Precio Compra:</span>
                                    <span class="info-value price-compra">{{ producto.precio_compra | number:'1.0-0' }} COP</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Precio Venta:</span>
                                    <span class="info-value price">{{ producto.precio_venta | number:'1.0-0' }} COP</span>
                                </div>
                            </div>
                            <div class="producto-categoria-desc" *ngIf="producto.descripcion">
                                <i class="fas fa-align-left"></i>
                                <span>{{ producto.descripcion }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="empty-list" *ngIf="productosCategoriaSeleccionada.length === 0">
                    <i class="fas fa-box-open"></i>
                    <p>No hay productos en esta categoría</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" (click)="cerrarModalCategoria()">
                    <i class="fas fa-times"></i>
                    Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Ver Imagen -->
<div class="modal fade" id="modal-ver-imagen-dashboard" tabindex="-1" role="dialog" aria-labelledby="modalImagenDashboardLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalImagenDashboardLabel">
                    <i class="fas fa-image"></i>
                    Imagen del Producto: {{ productoNombreCargandoImagen }}
                </h5>
                <button type="button" class="close" (click)="closeImageModal()" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body text-center">
                <div *ngIf="isLoadingImage" class="loading-image">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Cargando imagen...</p>
                </div>
                <img *ngIf="!isLoadingImage && imagen_view" 
                    [src]="imagen_view" 
                    alt="Imagen del producto" 
                    class="product-image-modal">
                <div *ngIf="!isLoadingImage && !imagen_view" class="no-image">
                    <i class="fas fa-image"></i>
                    <p>No hay imagen disponible</p>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Modal para Ver Imagen -->

<!-- Modal para Actualizar Saldos -->
<div class="modal fade" id="modalActualizarSaldos" tabindex="-1" role="dialog" aria-labelledby="modalActualizarSaldosLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h5 class="modal-title" id="modalActualizarSaldosLabel">
                        <i class="fas fa-exchange-alt"></i>
                        Registrar Movimiento de Saldos
                    </h5>
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i>
                        Registra cambios en los saldos y explica el motivo del movimiento
                    </small>
                </div>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" (click)="closeUpdateModal()">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form #saldosForm="ngForm">
                    <div class="row">
                        <!-- Efectivo -->
                        <div class="col-md-4 mb-3">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-money-bill-wave"></i>
                                    Efectivo (COP)
                                </label>
                                <div class="input-group input-group-currency">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text">$</span>
                                    </div>
                                    <input type="number" 
                                           class="form-control" 
                                           name="efectivo" 
                                           [(ngModel)]="saldos.efectivo"
                                           #efectivo="ngModel"
                                           min="0"
                                           step="1"
                                           placeholder="0">
                                </div>
                                <small class="form-text text-muted" *ngIf="originalSaldos.efectivo !== saldos.efectivo">
                                    Original: {{ originalSaldos.efectivo | number:'1.0-0' }} COP
                                </small>
                            </div>
                        </div>

                        <!-- Nequi -->
                        <div class="col-md-4 mb-3">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-mobile-alt"></i>
                                    Nequi (COP)
                                </label>
                                <div class="input-group input-group-currency">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text">$</span>
                                    </div>
                                    <input type="number" 
                                           class="form-control" 
                                           name="nequi" 
                                           [(ngModel)]="saldos.nequi"
                                           #nequi="ngModel"
                                           min="0"
                                           step="1"
                                           placeholder="0">
                                </div>
                                <small class="form-text text-muted" *ngIf="originalSaldos.nequi !== saldos.nequi">
                                    Original: {{ originalSaldos.nequi | number:'1.0-0' }} COP
                                </small>
                            </div>
                        </div>

                        <!-- Sin Pagar -->
                        <div class="col-md-4 mb-3">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    Sin Pagar (COP)
                                </label>
                                <div class="input-group input-group-currency">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text">$</span>
                                    </div>
                                    <input type="number" 
                                           class="form-control" 
                                           name="sin_pagar" 
                                           [(ngModel)]="saldos.sin_pagar"
                                           #sin_pagar="ngModel"
                                           min="0"
                                           step="1"
                                           placeholder="0">
                                </div>
                                <small class="form-text text-muted" *ngIf="originalSaldos.sin_pagar !== saldos.sin_pagar">
                                    Original: {{ originalSaldos.sin_pagar | number:'1.0-0' }} COP
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Información Sin Pagar -->
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-info-circle"></i>
                            Información sobre "Sin Pagar"
                        </label>
                        <textarea class="form-control" 
                                  rows="3"
                                  name="info_sin_pagar" 
                                  [(ngModel)]="saldos.info_sin_pagar"
                                  #info_sin_pagar="ngModel"
                                  placeholder="Describe detalles sobre los pagos pendientes..."></textarea>
                    </div>

                    <!-- Motivo del Cambio -->
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-comment-alt"></i>
                            Motivo del Movimiento <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" 
                                  rows="4"
                                  name="motivo" 
                                  [(ngModel)]="nuevoMotivo"
                                  #motivo="ngModel"
                                  required
                                  placeholder="Ejemplo: Retiro de efectivo para compra de mercancía, Transferencia de Nequi a efectivo, Pago recibido de cliente pendiente, etc..."></textarea>
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle"></i>
                            Describe claramente por qué se están moviendo los saldos. Este registro quedará en el historial para auditoría.
                        </small>
                        <div class="motivo-anterior mt-2" *ngIf="originalMotif">
                            <i class="fas fa-history"></i>
                            <strong>Último motivo:</strong> {{ originalMotif }}
                        </div>
                    </div>

                    <!-- Resumen de Cambios -->
                    <div class="alert alert-warning" *ngIf="hasChanges()">
                        <h6><i class="fas fa-exchange-alt"></i> Resumen del Movimiento:</h6>
                        <div class="movement-summary">
                            <div class="movement-item" *ngIf="originalSaldos.efectivo !== saldos.efectivo">
                                <div class="movement-label">
                                    <i class="fas fa-money-bill-wave"></i>
                                    <strong>Efectivo</strong>
                                </div>
                                <div class="movement-values">
                                    <span class="movement-old">{{ originalSaldos.efectivo | currency:'COP':'symbol':'1.0-0' }}</span>
                                    <i class="fas fa-arrow-right"></i>
                                    <span class="movement-new">{{ saldos.efectivo | currency:'COP':'symbol':'1.0-0' }}</span>
                                    <span class="movement-diff" 
                                          [class.text-success]="saldos.efectivo > originalSaldos.efectivo" 
                                          [class.text-danger]="saldos.efectivo < originalSaldos.efectivo">
                                        <i class="fas" 
                                           [class.fa-arrow-up]="saldos.efectivo > originalSaldos.efectivo"
                                           [class.fa-arrow-down]="saldos.efectivo < originalSaldos.efectivo"></i>
                                        {{ (saldos.efectivo - originalSaldos.efectivo) | currency:'COP':'symbol':'1.0-0' }}
                                    </span>
                                </div>
                            </div>
                            <div class="movement-item" *ngIf="originalSaldos.nequi !== saldos.nequi">
                                <div class="movement-label">
                                    <i class="fas fa-mobile-alt"></i>
                                    <strong>Nequi</strong>
                                </div>
                                <div class="movement-values">
                                    <span class="movement-old">{{ originalSaldos.nequi | number:'1.0-0' }} COP</span>
                                    <i class="fas fa-arrow-right"></i>
                                    <span class="movement-new">{{ saldos.nequi | number:'1.0-0' }} COP</span>
                                    <span class="movement-diff" 
                                          [class.text-success]="saldos.nequi > originalSaldos.nequi" 
                                          [class.text-danger]="saldos.nequi < originalSaldos.nequi">
                                        <i class="fas" 
                                           [class.fa-arrow-up]="saldos.nequi > originalSaldos.nequi"
                                           [class.fa-arrow-down]="saldos.nequi < originalSaldos.nequi"></i>
                                        {{ (saldos.nequi - originalSaldos.nequi) | number:'1.0-0' }} COP
                                    </span>
                                </div>
                            </div>
                            <div class="movement-item" *ngIf="originalSaldos.sin_pagar !== saldos.sin_pagar">
                                <div class="movement-label">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <strong>Sin Pagar</strong>
                                </div>
                                <div class="movement-values">
                                    <span class="movement-old">{{ originalSaldos.sin_pagar | number:'1.0-0' }} COP</span>
                                    <i class="fas fa-arrow-right"></i>
                                    <span class="movement-new">{{ saldos.sin_pagar | number:'1.0-0' }} COP</span>
                                    <span class="movement-diff" 
                                          [class.text-success]="saldos.sin_pagar < originalSaldos.sin_pagar" 
                                          [class.text-danger]="saldos.sin_pagar > originalSaldos.sin_pagar">
                                        <i class="fas" 
                                           [class.fa-arrow-up]="saldos.sin_pagar > originalSaldos.sin_pagar"
                                           [class.fa-arrow-down]="saldos.sin_pagar < originalSaldos.sin_pagar"></i>
                                        {{ (saldos.sin_pagar - originalSaldos.sin_pagar) | number:'1.0-0' }} COP
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="alert-no-changes" *ngIf="!hasChanges()">
                        <i class="fas fa-info-circle"></i>
                        <span>No has realizado cambios en los saldos. Si deseas registrar un movimiento, modifica al menos uno de los valores.</span>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" (click)="closeUpdateModal()">
                    <i class="fas fa-times"></i>
                    Cancelar
                </button>
                <button type="button" 
                        class="btn btn-primary" 
                        (click)="actualizarSaldos()"
                        [disabled]="!nuevoMotivo || nuevoMotivo.trim() === '' || nuevoMotivo === originalMotif || isSaving">
                    <i class="fas fa-save" *ngIf="!isSaving"></i>
                    <i class="fas fa-spinner fa-spin" *ngIf="isSaving"></i>
                    {{ isSaving ? 'Guardando...' : 'Guardar Cambios' }}
                </button>
            </div>
        </div>
    </div>
</div>