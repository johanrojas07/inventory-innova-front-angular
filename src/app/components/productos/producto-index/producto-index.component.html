<div class="wrapper">
    <app-sidebar></app-sidebar>

    <div class="main">
        <!-- <nav class="navbar navbar-expand navbar-theme">
            <a class="sidebar-toggle d-flex mr-2">
                <i class="hamburger align-self-center"></i>
            </a>
        </nav> -->
        <main class="content">
            <div class="container-fluid">
                <div class="header mb-1">
                    <h1 class="header-title">
                        <span>Productos</span>
                        <a [routerLink]="['/producto/registrar']" class="btn btn-primary btn-nuevo">
                            <i class="fas fa-plus"></i>
                            <span>Nuevo Producto</span>
                        </a>
                    </h1>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a>Productos</a></li>
                        </ol>
                    </nav>
                </div>
                <div class="row">
                    <div class="col-12 col-lg-12" *ngIf="success_message">
                        <div class="alert alert-info alert-dismissible" role="alert">
                            <div class="alert-message">
                                {{success_message}}
                            </div>

                            <button type="button" class="close" (click)="close_alert()" data-dismiss="alert"
                                aria-label="Close">
                                <span aria-hidden="true">×</span>
                            </button>
                        </div>
                    </div>
                    <div class="col-12 col-xl-12">
                        <div class="card">
                            <div class="card-header">
                                <div class="row">
                                    <div class="col-lg-6">
                                        <h5 class="card-title">Filtro de productos</h5>
                                        <form #searchForm="ngForm">
                                            <div class="input-group date" id="datetimepicker-minimum"
                                                data-target-input="nearest">
                                                <input type="text" class="form-control datetimepicker-input"
                                                    #filtro="ngModel" name="filtro"
                                                    (input)="filterData($event.target.value)" [(ngModel)]="filtroText">
                                                <div class="input-group-append">

                                                    <button type="submit" class="input-group-text"><i
                                                            class="fa fa-search"></i></button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="col-lg-6">
                                        <h5 class="card-title">Opciones de productos</h5>
                                        <div class="btn-group">

                                            <button type="button" class="btn mb-1 btn-primary dropdown-toggle"
                                                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                Opciones
                                            </button>
                                            <div class="dropdown-menu">
                                                <a class="dropdown-item"
                                                    [routerLink]="['/producto/registrar']">Registrar producto</a>
                                                <a class="dropdown-item" (click)="openCategoriasModal()">Ver categorias</a>

                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                            <mat-progress-bar mode="indeterminate" *ngIf="isLoading"></mat-progress-bar>
                            <div class="table-responsive" *ngIf="!isLoading">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th><i class="fas fa-barcode"></i> Identificador</th>
                                            <th><i class="fas fa-box"></i> Producto</th>
                                            <th class="text-center"><i class="fas fa-warehouse"></i> Stock</th>
                                            <th class="text-center"><i class="fas fa-dollar-sign"></i> Precio Venta</th>
                                            <th class="text-center"><i class="fas fa-cog"></i> Opciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr *ngFor="let item of filtroProductos | paginate: { itemsPerPage: 15, currentPage: paginator }; let idx = index">
                                            <td>
                                                <span class="product-id">{{item.identificador}}</span>
                                            </td>
                                            <td>
                                                <div class="product-info">
                                                    <div class="producto-image-preview" 
                                                         [attr.data-producto-id]="item._id"
                                                         (click)="swipe(item._id)"
                                                         [title]="getProductImage(item) ? 'Ver imagen' : (isImageLoading(item) ? 'Cargando imagen...' : 'Ver imagen')">
                                                        <img *ngIf="getProductImage(item)" 
                                                             [src]="getProductImage(item)" 
                                                             [alt]="item.titulo"
                                                             class="producto-preview-thumbnail">
                                                        <i *ngIf="!getProductImage(item) && !isImageLoading(item)" 
                                                           class="fas fa-image"></i>
                                                        <i *ngIf="isImageLoading(item)" 
                                                           class="fas fa-spinner fa-spin"></i>
                                                    </div>
                                                    <span class="product-name">{{item.titulo}}</span>
                                                </div>
                                            </td>
                                            <td class="text-center">
                                                <span class="stock-badge" [class.low-stock]="item.stock < 10" [class.no-stock]="item.stock === 0">
                                                    {{item.stock}}
                                                </span>
                                            </td>
                                            <td class="text-center">
                                                <span class="price-value" matTooltip="Precio Compra: ${{item.precio_compra | number}}">
                                                    ${{item.precio_venta | number}}
                                                </span>
                                            </td>
                                            <td>
                                                <div class="btn-group-actions">
                                                    <button type="button" class="btn btn-sm btn-edit" 
                                                        [routerLink]="['/producto/editar/',item._id]" title="Editar">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-stock" 
                                                        (click)="get_id(item._id)" title="Aumentar Stock">
                                                        <i class="fas fa-plus-circle"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-delete" 
                                                        (click)="eliminar(item._id)" title="Eliminar">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr *ngIf="!filtroProductos || filtroProductos.length === 0">
                                            <td colspan="5" class="text-center empty-table">
                                                <i class="fas fa-box"></i>
                                                <p>No se encontraron productos</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <pagination-controls (pageChange)="paginator = $event"></pagination-controls>
                </div>


                <!--MODAL AGREGAR/EDITAR CATEGORIA-->
                <div class="modal fade" id="modal-save-categoria" tabindex="-1" role="dialog" style="display: none;"
                    aria-hidden="true">
                    <form #categoriaForm="ngForm" (ngSubmit)="save_cat(categoriaForm)">
                        <div class="modal-dialog modal-dialog-centered" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">
                                        <i class="fas" [class.fa-plus]="!categoriaEditando._id" [class.fa-edit]="categoriaEditando._id"></i>
                                        {{categoriaEditando._id ? 'Editar Categoría' : 'Registrar Categoría'}}
                                    </h5>
                                    <button type="button" class="close" (click)="closeNuevaCategoriaModal()" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <div class="form-group">
                                        <label><i class="fas fa-tag"></i> Título de la Categoría</label>
                                        <input type="text" class="form-control" placeholder="Ej: Electrónica, Ropa, Alimentos..."
                                            #titulo_cat="ngModel" name="titulo_cat" [(ngModel)]="categoriaEditando.titulo"
                                            required>
                                    </div>
                                    <div class="form-group">
                                        <label><i class="fas fa-align-left"></i> Descripción</label>
                                        <textarea class="form-control" rows="3" placeholder="Breve descripción de la categoría..."
                                            #descripcion_cat="ngModel" name="descripcion_cat"
                                            [(ngModel)]="categoriaEditando.descripcion" required></textarea>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" (click)="closeNuevaCategoriaModal()">
                                        <i class="fas fa-times"></i>
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary" [disabled]="isSavingCategoria">
                                        <i class="fas" [class.fa-save]="!isSavingCategoria" [class.fa-spinner]="isSavingCategoria" [class.fa-spin]="isSavingCategoria"></i>
                                        {{isSavingCategoria ? 'Guardando...' : (categoriaEditando._id ? 'Actualizar' : 'Registrar')}}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <!--MODAL AGREGAR/EDITAR CATEGORIA-->

                <!--MODAL VER IMAGEN-->
                <div class="modal fade" id="modal-ver-imagen" tabindex="-1" role="dialog" aria-labelledby="modalImagenLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="modalImagenLabel">
                                    <i class="fas fa-image"></i>
                                    Imagen del Producto
                                </h5>
                                <button type="button" class="close" (click)="closeImageModal()" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body text-center">
                                <div *ngIf="isLoadingImage" class="loading-image">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <p>Cargando imagen...</p>
                                </div>
                                <img *ngIf="!isLoadingImage && imagen_view" 
                                    [src]="imagen_view" 
                                    alt="Imagen del producto" 
                                    class="product-image-modal">
                                <div *ngIf="!isLoadingImage && !imagen_view" class="no-image">
                                    <i class="fas fa-image"></i>
                                    <p>No hay imagen disponible</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--MODAL VER IMAGEN-->

                <!--MODAL LISTAR CATEGORIA-->
                <div class="modal fade" id="modal-data-categoria" tabindex="-1" role="dialog" style="display: none;"
                    aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg" role="document">
                        <div class="modal-content">
                            <div class="modal-header modal-header-categorias">
                                <h5 class="modal-title">
                                    <i class="fas fa-tags"></i>
                                    Gestión de Categorías
                                </h5>
                                <div class="header-actions">
                                    <button type="button" class="btn btn-primary btn-sm btn-add-categoria" 
                                        (click)="openNuevaCategoriaModal()" title="Nueva Categoría">
                                        <i class="fas fa-plus"></i>
                                        <span>Nueva</span>
                                    </button>
                                    <button type="button" class="close" (click)="closeCategoriasModal()" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                            </div>
                            <div class="modal-body modal-body-categorias">
                                <!-- Buscador -->
                                <div class="categorias-search-wrapper" *ngIf="categorias && categorias.length > 0">
                                    <div class="search-box-categorias">
                                        <i class="fas fa-search"></i>
                                        <input 
                                            type="text" 
                                            class="form-control search-input-categorias" 
                                            placeholder="Buscar categoría por título o descripción..." 
                                            [(ngModel)]="categoriaBusqueda"
                                            (input)="filtrarCategorias()"
                                            [ngModelOptions]="{standalone: true}">
                                        <button 
                                            type="button" 
                                            class="btn-clear-search" 
                                            *ngIf="categoriaBusqueda"
                                            (click)="limpiarBusquedaCategorias()"
                                            title="Limpiar búsqueda">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <div class="categorias-count">
                                        <span *ngIf="categoriasFiltradas.length === categorias.length">
                                            {{ categorias.length }} categoría(s)
                                        </span>
                                        <span *ngIf="categoriasFiltradas.length !== categorias.length">
                                            {{ categoriasFiltradas.length }} de {{ categorias.length }} categoría(s)
                                        </span>
                                    </div>
                                </div>

                                <!-- Estado vacío -->
                                <div *ngIf="!categorias || categorias.length === 0" class="empty-categorias">
                                    <i class="fas fa-inbox"></i>
                                    <p>No hay categorías registradas</p>
                                    <button type="button" class="btn btn-primary" (click)="openNuevaCategoriaModal()">
                                        <i class="fas fa-plus"></i>
                                        Crear Primera Categoría
                                    </button>
                                </div>

                                <!-- Sin resultados de búsqueda -->
                                <div *ngIf="categorias && categorias.length > 0 && categoriasFiltradas.length === 0" class="empty-categorias">
                                    <i class="fas fa-search"></i>
                                    <p>No se encontraron categorías que coincidan con "{{ categoriaBusqueda }}"</p>
                                    <button type="button" class="btn btn-secondary" (click)="limpiarBusquedaCategorias()">
                                        <i class="fas fa-times"></i>
                                        Limpiar búsqueda
                                    </button>
                                </div>

                                <!-- Tabla de categorías -->
                                <div *ngIf="categorias && categorias.length > 0 && categoriasFiltradas.length > 0" class="categorias-table-wrapper">
                                    <table class="table table-categorias">
                                        <thead>
                                            <tr>
                                                <th class="categoria-col-titulo">
                                                    <i class="fas fa-tag"></i>
                                                    Título
                                                </th>
                                                <th class="categoria-col-descripcion">
                                                    <i class="fas fa-align-left"></i>
                                                    Descripción
                                                </th>
                                                <th class="categoria-col-acciones text-center">
                                                    <i class="fas fa-cog"></i>
                                                    Acciones
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr *ngFor="let item of categoriasFiltradas">
                                                <td class="categoria-cell-titulo">
                                                    <span class="categoria-titulo">{{item.titulo}}</span>
                                                </td>
                                                <td class="categoria-cell-descripcion">
                                                    <span class="categoria-descripcion" 
                                                        [title]="item.descripcion || 'Sin descripción'">
                                                        {{item.descripcion || 'Sin descripción'}}
                                                    </span>
                                                </td>
                                                <td class="categoria-cell-acciones">
                                                    <div class="btn-group-actions-categoria">
                                                        <button type="button" class="btn btn-sm btn-edit-categoria" 
                                                            (click)="openEditarCategoriaModal(item)" title="Editar">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-delete-categoria" 
                                                            (click)="eliminarCategoria(item._id)" title="Eliminar">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" (click)="closeCategoriasModal()">
                                    <i class="fas fa-times"></i>
                                    Cerrar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <!--MODAL LISTAR CATEGORIA-->

                <!-- Modal Aumentar/Reducir Stock -->
                <div class="modal fade" id="modalStock" tabindex="-1" role="dialog" aria-labelledby="modalStockLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <div>
                                    <h5 class="modal-title" id="modalStockLabel">
                                        <i class="fas fa-boxes"></i>
                                        Gestión de Stock
                                    </h5>
                                    <small class="text-muted" *ngIf="productoStockSeleccionado">
                                        <i class="fas fa-info-circle"></i>
                                        {{ productoStockSeleccionado.titulo }}
                                    </small>
                                </div>
                                <button type="button" class="close" (click)="closeStockModal()" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body" *ngIf="productoStockSeleccionado">
                                <!-- Información del Producto -->
                                <div class="producto-stock-info">
                                    <div class="producto-stock-image">
                                        <img *ngIf="getProductImage(productoStockSeleccionado)" 
                                             [src]="getProductImage(productoStockSeleccionado)" 
                                             [alt]="productoStockSeleccionado.titulo"
                                             class="producto-stock-img">
                                        <div *ngIf="!getProductImage(productoStockSeleccionado)" class="producto-stock-no-image">
                                            <i class="fas fa-image"></i>
                                        </div>
                                    </div>
                                    <div class="producto-stock-details">
                                        <div class="stock-detail-item">
                                            <span class="stock-label">ID:</span>
                                            <span class="stock-value">{{ productoStockSeleccionado.identificador || 'N/A' }}</span>
                                        </div>
                                        <div class="stock-detail-item">
                                            <span class="stock-label">Stock Actual:</span>
                                            <span class="stock-value stock-actual" 
                                                  [class.stock-critico]="productoStockSeleccionado.stock <= 3"
                                                  [class.stock-bajo]="productoStockSeleccionado.stock > 3 && productoStockSeleccionado.stock <= 5"
                                                  [class.stock-ok]="productoStockSeleccionado.stock > 5">
                                                <i class="fas fa-boxes"></i>
                                                {{ productoStockSeleccionado.stock }} unidades
                                            </span>
                                        </div>
                                        <div class="stock-detail-item" *ngIf="productoStockSeleccionado.precio_compra">
                                            <span class="stock-label">Precio Compra:</span>
                                            <span class="stock-value">{{ productoStockSeleccionado.precio_compra | number:'1.0-0' }} COP</span>
                                        </div>
                                    </div>
                                </div>

                                <form #stockForm="ngForm" (ngSubmit)="aumentar_stock(stockForm)">
                                    <!-- Tipo de Operación -->
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="fas fa-exchange-alt"></i>
                                            Tipo de Operación
                                        </label>
                                        <div class="btn-group-operacion">
                                            <button type="button" 
                                                    class="btn btn-operacion" 
                                                    [class.active]="tipoOperacionStock === 'aumentar'"
                                                    (click)="tipoOperacionStock = 'aumentar'; producto_stockText = ''; calcularNuevoStock()">
                                                <i class="fas fa-plus-circle"></i>
                                                Aumentar Stock
                                            </button>
                                            <button type="button" 
                                                    class="btn btn-operacion" 
                                                    [class.active]="tipoOperacionStock === 'reducir'"
                                                    (click)="tipoOperacionStock = 'reducir'; producto_stockText = ''; calcularNuevoStock()">
                                                <i class="fas fa-minus-circle"></i>
                                                Reducir Stock
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Cantidad -->
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="fas fa-hashtag"></i>
                                            Cantidad a {{ tipoOperacionStock === 'aumentar' ? 'Agregar' : 'Reducir' }}
                                        </label>
                                        <input type="number" 
                                               class="form-control" 
                                               placeholder="Ingrese la cantidad"
                                               #producto_stock="ngModel" 
                                               name="producto_stock" 
                                               [(ngModel)]="producto_stockText" 
                                               (ngModelChange)="calcularNuevoStock()"
                                               [min]="1"
                                               [max]="tipoOperacionStock === 'reducir' ? productoStockSeleccionado.stock : null"
                                               required>
                                        <small class="form-text text-muted">
                                            Ingrese la cantidad de unidades a {{ tipoOperacionStock === 'aumentar' ? 'agregar' : 'reducir' }} al stock
                                        </small>
                                    </div>

                                    <!-- Botones de Cantidad Rápida -->
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="fas fa-bolt"></i>
                                            Cantidades Rápidas
                                        </label>
                                        <div class="btn-group-rapidas">
                                            <button type="button" 
                                                    class="btn btn-rapida" 
                                                    *ngFor="let cantidad of [1, 5, 10, 25, 50, 100]"
                                                    (click)="setCantidadRapida(cantidad)">
                                                {{ cantidad }}
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Resumen del Cambio -->
                                    <div class="stock-resumen" *ngIf="producto_stockText && getStockNumber(producto_stockText) > 0">
                                        <div class="resumen-item">
                                            <span class="resumen-label">Stock Actual:</span>
                                            <span class="resumen-value">{{ productoStockSeleccionado.stock }} unidades</span>
                                        </div>
                                        <div class="resumen-item">
                                            <span class="resumen-label">
                                                <i class="fas" [class.fa-plus]="tipoOperacionStock === 'aumentar'" [class.fa-minus]="tipoOperacionStock === 'reducir'"></i>
                                                {{ tipoOperacionStock === 'aumentar' ? 'Aumento' : 'Reducción' }}:
                                            </span>
                                            <span class="resumen-value" 
                                                  [class.text-success]="tipoOperacionStock === 'aumentar'"
                                                  [class.text-danger]="tipoOperacionStock === 'reducir'">
                                                {{ tipoOperacionStock === 'aumentar' ? '+' : '-' }}{{ producto_stockText }} unidades
                                            </span>
                                        </div>
                                        <div class="resumen-item resumen-total">
                                            <span class="resumen-label">Nuevo Stock:</span>
                                            <span class="resumen-value resumen-nuevo" 
                                                  [class.stock-critico]="nuevoStockCalculado <= 3"
                                                  [class.stock-bajo]="nuevoStockCalculado > 3 && nuevoStockCalculado <= 5"
                                                  [class.stock-ok]="nuevoStockCalculado > 5">
                                                {{ nuevoStockCalculado }} unidades
                                            </span>
                                        </div>
                                        <div class="resumen-alerta" *ngIf="tipoOperacionStock === 'reducir' && nuevoStockCalculado <= 3 && nuevoStockCalculado > 0">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            <span>El stock quedará bajo después de esta operación</span>
                                        </div>
                                        <div class="resumen-alerta resumen-error" *ngIf="tipoOperacionStock === 'reducir' && nuevoStockCalculado < 0">
                                            <i class="fas fa-times-circle"></i>
                                            <span>No se puede reducir más stock del disponible</span>
                                        </div>
                                    </div>

                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" (click)="closeStockModal()">
                                            <i class="fas fa-times"></i>
                                            Cancelar
                                        </button>
                                        <button type="submit" 
                                                class="btn" 
                                                [class.btn-success]="tipoOperacionStock === 'aumentar'"
                                                [class.btn-warning]="tipoOperacionStock === 'reducir'"
                                                [disabled]="isSavingStock || (tipoOperacionStock === 'reducir' && nuevoStockCalculado < 0)">
                                            <i class="fas" 
                                               [class.fa-plus]="tipoOperacionStock === 'aumentar' && !isSavingStock"
                                               [class.fa-minus]="tipoOperacionStock === 'reducir' && !isSavingStock"
                                               [class.fa-spinner]="isSavingStock"
                                               [class.fa-spin]="isSavingStock"></i>
                                            {{isSavingStock ? 'Guardando...' : (tipoOperacionStock === 'aumentar' ? 'Aumentar Stock' : 'Reducir Stock')}}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>

    </div>
</div>